{{- if .Values.ingress.enabled }}

# =================================================================
# Ingress-NGINX Controller Service
# 외부 트래픽이 클러스터 내부로 들어오는 진입점(Entrypoint)을 설정합니다.
# 이 Service는 Ingress Controller Pod 자체를 외부에 노출시키는 역할을 합니다.
# =================================================================
# apiVersion: v1
# kind: Service
# metadata:
#   name: ingress-nginx-controller
#   namespace: ingress-nginx          # Ingress Controller가 설치된 'ingress-nginx' 네임스페이스에 생성됩니다.
#   # annotations:
#   #   metallb.universe.tf/allow-shared-ip: "vip-10-40-16-50"
# spec:
#   type: LoadBalancer                # 로드 밸런서 타입으로 서비스를 노출합니다.
#   loadBalancerIP: 10.40.16.50
#     #  externalTrafficPolicy: Cluster
#   ports:
#   - name: http
#     port: 80                        # 서비스가 외부에서 80번 포트로 HTTP 요청을 받습니다.
#     protocol: TCP
#     targetPort: 80                  # 받은 요청을 Ingress Controller Pod의 80번 포트로 전달합니다.30547
#   - name: https
#     port: 443                       # 서비스가 외부에서 443번 포트로 HTTPS 요청을 받습니다.
#     protocol: TCP
#     targetPort: 443                 # 받은 요청을 Ingress Controller Pod의 443번 포트로 전달합니다.
#   - name: mqtt
#     port: 1883
#     targetPort: 1883
#   - name: rabbitmq-ui
#     port: 15672
#     targetPort: 15672
#   - name: redisinsight
#     port: 8001
#     targetPort: 8001
#   - name: kibana
#     port: 5601
#     targetPort: 5601
#   selector:                         # 이 서비스가 트래픽을 전달할 Pod를 선택하는 라벨입니다.
#     app.kubernetes.io/component: controller
#     app.kubernetes.io/instance: ingress-nginx
#     app.kubernetes.io/name: ingress-nginx

---
# =================================================================
# Ingress Rules for CROMS Application
# Ingress Controller에 도메인 및 경로 기반의 라우팅 규칙을 정의합니다.
# =================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: croms-ingress
  namespace: croms                  # 애플리케이션이 배포된 'croms' 네임스페이스에 생성됩니다.
  annotations:                      # Ingress Controller의 동작을 상세하게 제어하기 위한 설정
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"     # HTTP 접속을 HTTPS로 강제 리다이렉트하지 않음
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"      # 백엔드 서비스 응답 대기 시간 (초)
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"      # 백엔드 서비스로 요청 전송 대기 시간 (초)
    nginx.ingress.kubernetes.io/proxy-body-size: "0"            # 클라이언트 요청 본문 크기 제한 없음 (파일 업로드 등)
    nginx.ingress.kubernetes.io/proxy-upgrade: "websocket"      # WebSocket 프로토콜 지원 활성화
    nginx.ingress.kubernetes.io/proxy-connection: "Upgrade"
spec:
  ingressClassName: nginx           # 'nginx' Ingress Class를 사용하는 Ingress Controller가 이 규칙을 처리하도록 지정
    #  tls:                              # HTTPS 통신을 위한 TLS(SSL) 인증서 설정
    #  - hosts:
    #    - k8s-incheon-airport.croms.co.kr # TLS 인증서가 적용될 호스트 이름
    #    secretName: croms-tls-secret    # TLS 인증서와 개인키가 저장된 Secret의 이름
  rules:
    #  - host: 10.40.16.21 # 이 호스트 이름으로 들어오는 요청에 대해 아래 규칙을 적용
  - http:
      paths:                        # 경로 기반 라우팅 규칙 목록
      - path: /websocket            # '/websocket' 경로로 들어오는 요청
        pathType: Prefix
        backend:
          service:
            name: croms-core-service # 'croms-core-service'로 전달
            port:
              number: 9195
      - path: /oauth2               # '/oauth2' 경로로 들어오는 요청
        pathType: Prefix
        backend:
          service:
            name: croms-auth-service # 'croms-auth-service'로 전달
            port:
              number: 9194
      - path: /api                  # '/api' 경로로 들어오는 요청
        pathType: Prefix
        backend:
          service:
            name: croms-core-service # 'croms-core-service'로 전달
            port:
              number: 9195
      - path: /proxyapi                  # '/proxyapi' 경로로 들어오는 요청
        pathType: Prefix
        backend:
          service:
            name: croms-core-service # 'croms-core-service'로 전달
            port:
              number: 9195
      - path: /robot
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /file
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /contentfile
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /ct
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /scene
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /template_thumbnail
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /content_thumbnail
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /thumbnail
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /menu_thumbnail
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /sf
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /emotion
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /eai
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /docent
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /act
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /stats
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /cr
        pathType: Prefix
        backend:
          service:
            name: cms-backend-service
            port:
              number: 5545
      - path: /cms
        pathType: Prefix
        backend:
          service:
            name: cms-front-service
            port:
              number: 5445
      - path: /                     # 위 경로들에 해당하지 않는 모든 요청
        pathType: Prefix
        backend:
          service:
            name: croms-front-service # 'croms-front-service'로 전달
            port:
              number: 80



{{- end }}